<!DOCTYPE html>
<html>
  <head>
    <title>You're in control</title>
    <link rel="stylesheet" href="css/seq.css">
  </head>
  <body>
    <div id="sequencer">
      
      <div id="controls">
        <button id="play" class="controls">&#9654;</button><!-- &#9724; -->
        <div id="tempo" class="controls">60</div>
        <div id="currentStep" class="controls"></div>
      </div>

        <table id="matrix">
        </table>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="scripts/include.js"></script>
    <script>
        // Node stuff:
        var socket = io();
        socket.on('step value', function(msg) {
          console.log(msg);
          var stepID = "track"+msg.track+"-step"+msg.step;
          console.log(stepID)
          var step = document.getElementById(stepID);
          step.setAttribute("value",msg.value);
          if(msg.value == 0) step.style.backgroundColor = offColor;
          else step.style.backgroundColor = onColor;
        });

        socket.on('clear track', function(msg) {
          var trackClass = ".track"+msg.track;
          var steps = document.querySelectorAll(trackClass);
          steps.forEach(step =>{
            step.setAttribute("value",0);
            step.style.backgroundColor = offColor;
          });
        });

        // UI stuff:
        var matrix = document.getElementById("matrix");
        // Header
        var tr = document.createElement("tr");
        var th = document.createElement("th");
        var text = document.createTextNode("");
        th.append(text);
        tr.appendChild(th);
        for(var j=0; j<NUM_STEPS; j++) {
          var th = document.createElement("th");
          var text = document.createTextNode(j+1);
          th.append(text);
          tr.appendChild(th);
        }
        matrix.appendChild(tr);

        // tracks:
        for(var i=0; i<NUM_TRACKS; i++) {
          var tr = createTrack(i);
          matrix.appendChild(tr);
        }

        // MIDI Stuff:
        var MIDIport;
        if (navigator.requestMIDIAccess) {
          console.log('Browser supports MIDI!');
          navigator.requestMIDIAccess().then(success, failure);
        }

        function success(midi) {
          var outputs = midi.outputs.values();
          // outputs is an Iterator
          for (var output = outputs.next(); output && !output.done; output = outputs.next()) {
              if (output.value.name == "IAC Driver Bus 2: notes")
              {
                //console.log(output.value);
                MIDIport = midi.outputs.get(output.value.id);
                console.log(MIDIport);
              }
          }
        }
        function failure(){ console.log("MIDI not supported :(")};
        // Seq stuff:
        var tempo = document.getElementById("tempo").innerText;
        var playing = false;
        var interval = 60000/(4*tempo);
        var timer;
        var counter = 0;
        var prev = 15;
        var stepPos = document.querySelectorAll(".step"+counter);
        var prevPos = document.querySelectorAll(".step"+prev);
        document.querySelector("#play").addEventListener("click", function(e){
          if(playing) { // stop
            this.innerHTML = "&#9654;";
            clearInterval(timer);
            playing = false;
            updateCursor(-1, -1);
          } else { // play
            counter = 0;
            prev = 15;
            updateCursor(counter, prev);
            playStepNotes(counter);
            timer = setInterval(function(){
              if(counter < NUM_STEPS-1) {
                counter++;
                prev = counter - 1;
              } else {
                counter = 0;
                prev = 15;
              }
              updateCursor(counter, prev);
              playStepNotes(counter);
            }, interval);
            this.innerHTML = "&#9724;";
            playing = true;
          }
        });

        function updateCursor(counter, prev) {
          if(counter >=0) {
            var currentStepNum = document.getElementById("currentStep");
            currentStepNum.innerHTML = counter+1;
            var stepPos = document.querySelectorAll(".step"+counter);
            var prevPos = document.querySelectorAll(".step"+prev);
            prevPos.forEach(step => {
              step.parentElement.classList.remove("cursor");
            })
            stepPos.forEach(step => {
              step.parentElement.classList.add("cursor");
            });
          } else {
            var all = document.querySelectorAll(".step");
            all.forEach(step => {
              step.parentElement.classList.remove("cursor");
            })
          }
        }

        function playStepNotes(counter) {
          var stepPos = document.querySelectorAll(".step"+counter);
          stepPos.forEach(step => {
              var value = step.getAttribute("value");
              var track = parseInt(step.getAttribute("track"));
              if(value > 0) {
                playNote(36+track,MIDIport);
              }
          });
        }

    </script>
    

  </body>
</html>